{% extends "base.html" %}

{% block title %}ä»ªè¡¨ç›˜ - ç½‘é¡µå˜åŒ–ç›‘æ§ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ç›‘æ§ä»ªè¡¨ç›˜</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#notificationSettingsModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bell" viewBox="0 0 16 16"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.918zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/></svg>
            é€šçŸ¥è®¾ç½®
        </button>
        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#targetModal" data-action="add">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
            æ·»åŠ æ–°ç›®æ ‡
        </button>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category or 'success' }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th scope="col">çŠ¶æ€</th>
                <th scope="col">ç›‘æ§ç›®æ ‡</th>
                <th scope="col">è°ƒåº¦è®¡åˆ’ (Cron)</th>
                <th scope="col" class="text-center">æœ€æ–°å¿«ç…§</th>
                <th scope="col">ä¸Šæ¬¡æ£€æŸ¥</th>
                <th scope="col">ä¸Šæ¬¡å˜åŒ–</th>
                <th scope="col">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for target in targets %}
            <tr>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="toggle-{{ target.id }}" 
                               data-id="{{ target.id }}" onchange="toggleTarget(this)" {% if target.is_active %}checked{% endif %}>
                    </div>
                </td>
                <td>
                    <strong>{{ target.name or 'æœªå‘½åç›®æ ‡' }}</strong><br>
                    <small><a href="{{ target.url }}" target="_blank" title="{{ target.url }}">{{ target.url[:50] }}{% if target.url|length > 50 %}...{% endif %}</a></small>
                </td>
                <td><code>{{ target.cron_schedule }}</code></td>
                <td class="text-center">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#imagePreviewModal" 
                       data-img-url="{{ url_for('serve_screenshot', filename=target.screenshot_filename) }}"
                       data-img-name="{{ target.name or target.url }}">
                        <img src="{{ url_for('serve_screenshot', filename=target.screenshot_filename) }}?t={{ now().timestamp()|int }}" 
                             alt="å¿«ç…§é¢„è§ˆ" class="img-thumbnail" style="max-width: 150px; max-height: 80px; display: none;"
                             onload="this.style.display='inline-block'"
                             onerror="this.parentElement.innerHTML = '<span class=&quot;text-muted&quot;>æš‚æ— å¿«ç…§</span>'">
                    </a>
                </td>
                <td>{{ target.last_checked.strftime('%y-%m-%d %H:%M:%S') if target.last_checked else 'ä»æœª' }}</td>
                <td>{{ target.last_changed.strftime('%y-%m-%d %H:%M:%S') if target.last_changed else 'æ— å˜åŒ–' }}</td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#targetModal"
                            data-action="edit"
                            data-id="{{ target.id }}"
                            data-name="{{ target.name }}"
                            data-url="{{ target.url }}"
                            data-cron="{{ target.cron_schedule }}"
                            data-width="{{ target.screenshot_width }}"
                            data-height="{{ target.screenshot_max_height }}"
                            data-threshold="{{ target.threshold }}"
                            data-crop="{{ target.crop_area }}"
                            data-active="{{ 'on' if target.is_active else 'off' }}">
                        ç¼–è¾‘
                    </button>
                    <form action="{{ url_for('delete_target', target_id=target.id) }}" method="post" style="display:inline;" onsubmit="return confirm('æ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ä¸ªç›‘æ§ç›®æ ‡å—ï¼Ÿ');">
                       <button type="submit" class="btn btn-sm btn-outline-danger">åˆ é™¤</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center py-5">
                <h4>è¿˜æ²¡æœ‰ç›‘æ§ç›®æ ‡</h4>
                <p class="text-muted">è¯·ç‚¹å‡»å³ä¸Šè§’çš„ "æ·»åŠ æ–°ç›®æ ‡" æ¥å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡ç›‘æ§ã€‚</p>
            </td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- æ·»åŠ /ç¼–è¾‘ç›®æ ‡çš„æ¨¡æ€æ¡† -->
<div class="modal fade" id="targetModal" tabindex="-1" aria-labelledby="targetModalLabel" aria-hidden="true">
  <!-- ... (è¿™ä¸ªæ¨¡æ€æ¡†çš„å†…å®¹ä¿æŒä¸å˜) ... -->
</div>

<!-- ã€å…³é”®ä¿®æ­£ã€‘é€šçŸ¥è®¾ç½®çš„æ¨¡æ€æ¡† -->
<div class="modal fade" id="notificationSettingsModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('save_notifications') }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationModalLabel">å…¨å±€é€šçŸ¥è®¾ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="notificationAccordion">
                        <!-- Telegram è®¾ç½® -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTelegram">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTelegram" aria-expanded="true" aria-controls="collapseTelegram">
                                    <strong>âœˆï¸ Telegram é€šçŸ¥</strong>
                                </button>
                            </h2>
                            <div id="collapseTelegram" class="accordion-collapse collapse show" aria-labelledby="headingTelegram" data-bs-parent="#notificationAccordion">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <label for="telegram_bot_token" class="form-label">Bot Token</label>
                                        <input type="text" class="form-control" id="telegram_bot_token" name="telegram_bot_token" value="{{ notifications.telegram_bot_token if notifications }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="telegram_chat_id" class="form-label">Chat ID</label>
                                        <input type="text" class="form-control" id="telegram_chat_id" name="telegram_chat_id" value="{{ notifications.telegram_chat_id if notifications }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- SMTP é‚®ä»¶è®¾ç½® -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSmtp">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSmtp" aria-expanded="false" aria-controls="collapseSmtp">
                                    <strong>ğŸ“§ é‚®ä»¶é€šçŸ¥ (SMTP)</strong>
                                </button>
                            </h2>
                            <div id="collapseSmtp" class="accordion-collapse collapse" aria-labelledby="headingSmtp" data-bs-parent="#notificationAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-8 mb-3">
                                            <label for="smtp_host" class="form-label">SMTP ä¸»æœº</label>
                                            <input type="text" class="form-control" id="smtp_host" name="smtp_host" value="{{ notifications.smtp_host if notifications }}">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="smtp_port" class="form-label">ç«¯å£</label>
                                            <input type="number" class="form-control" id="smtp_port" name="smtp_port" value="{{ notifications.smtp_port if notifications }}">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="smtp_user" class="form-label">ç”¨æˆ·å</label>
                                        <input type="text" class="form-control" id="smtp_user" name="smtp_user" value="{{ notifications.smtp_user if notifications }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="smtp_password" class="form-label">å¯†ç æˆ–æˆæƒç </label>
                                        <input type="password" class="form-control" id="smtp_password" name="smtp_password" value="">
                                        <div class="form-text">ä¸ºå®‰å…¨èµ·è§ï¼Œæ­¤å¤„ä¸æ˜¾ç¤ºå·²ä¿å­˜çš„å¯†ç ã€‚å¦‚éœ€ä¿®æ”¹ï¼Œè¯·ç›´æ¥è¾“å…¥æ–°å¯†ç ã€‚</div>
                                    </div>
                                     <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="smtp_from" class="form-label">å‘ä»¶äººåœ°å€</label>
                                            <input type="email" class="form-control" id="smtp_from" name="smtp_from" value="{{ notifications.smtp_from if notifications }}">
                                            <div class="form-text">å¯ç•™ç©ºï¼Œé»˜è®¤ä¸ºç”¨æˆ·åã€‚</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="to_email" class="form-label">æ”¶ä»¶äººåœ°å€</label>
                                            <input type="email" class="form-control" id="to_email" name="to_email" value="{{ notifications.to_email if notifications }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜é€šçŸ¥è®¾ç½®</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
  <!-- ... (è¿™ä¸ªæ¨¡æ€æ¡†çš„å†…å®¹ä¿æŒä¸å˜) ... -->
</div>
{% endblock %}

{% block scripts %}
<!-- ... (è¿™ä¸ªè„šæœ¬å—çš„å†…å®¹ä¿æŒä¸å˜) ... -->
{% endblock %}
