{% extends "base.html" %}

{% block title %}ä»ªè¡¨ç›˜ - ç½‘é¡µå˜åŒ–ç›‘æ§ç³»ç»Ÿ{% endblock %}

{% block content %}
<style>
    #cropModal .modal-body {
        position: relative;
    }
    #crop-image {
        z-index: 1;
    }
    #crop-canvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 2;
        cursor: crosshair;
    }
</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ç›‘æ§ä»ªè¡¨ç›˜</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#notificationSettingsModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bell" viewBox="0 0 16 16"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.918zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/></svg>
            é€šçŸ¥è®¾ç½®
        </button>
        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#targetModal" data-action="add">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
            æ·»åŠ æ–°ç›®æ ‡
        </button>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category or 'success' }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th scope="col">çŠ¶æ€</th>
                <th scope="col">ç›‘æ§ç›®æ ‡</th>
                <th scope="col">è°ƒåº¦è®¡åˆ’ (Cron)</th>
                <th scope="col" class="text-center">æœ€æ–°å¿«ç…§</th>
                <th scope="col">ä¸Šæ¬¡æ£€æŸ¥</th>
                <th scope="col">ä¸Šæ¬¡å˜åŒ–</th>
                <th scope="col" style="min-width: 220px;">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for target in targets %}
            <tr>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="toggle-{{ target.id }}" 
                               data-id="{{ target.id }}" onchange="toggleTarget(this)" {% if target.is_active %}checked{% endif %}>
                    </div>
                </td>
                <td>
                    <strong>{{ target.name or 'æœªå‘½åç›®æ ‡' }}</strong><br>
                    <small><a href="{{ target.url }}" target="_blank" title="{{ target.url }}">{{ target.url[:50] }}{% if target.url|length > 50 %}...{% endif %}</a></small>
                </td>
                <td><code>{{ target.cron_schedule }}</code></td>
                <td class="text-center">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#imagePreviewModal" 
                       data-img-url="{{ url_for('serve_screenshot', filename=target.screenshot_filename) }}"
                       data-img-name="{{ target.name or target.url }}">
                        <img src="{{ url_for('serve_screenshot', filename=target.screenshot_filename) }}?t={{ now().timestamp()|int }}" 
                             alt="å¿«ç…§é¢„è§ˆ" class="img-thumbnail" style="max-width: 150px; max-height: 80px; display: none;"
                             onload="this.style.display='inline-block'"
                             onerror="this.parentElement.innerHTML = '<span class=&quot;text-muted&quot;>æš‚æ— å¿«ç…§</span>'">
                    </a>
                </td>
                <td>{{ target.last_checked.strftime('%y-%m-%d %H:%M:%S') if target.last_checked else 'ä»æœª' }}</td>
                <td>{{ target.last_changed.strftime('%y-%m-%d %H:%M:%S') if target.last_changed else 'æ— å˜åŒ–' }}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#targetModal"
                                data-action="edit"
                                data-id="{{ target.id }}"
                                data-name="{{ target.name }}"
                                data-url="{{ target.url }}"
                                data-cron="{{ target.cron_schedule }}"
                                data-width="{{ target.screenshot_width }}"
                                data-height="{{ target.screenshot_max_height }}"
                                data-threshold="{{ target.threshold }}"
                                data-crop="{{ target.crop_area }}"
                                data-cookies="{{ target.cookies }}"
                                data-login-method="{{ target.login_method }}"
                                data-login-username="{{ target.login_username }}"
                                data-login-password="{{ target.login_password }}"
                                data-username-selector="{{ target.username_selector }}"
                                data-password-selector="{{ target.password_selector }}"
                                data-submit-button-selector="{{ target.submit_button_selector }}"
                                data-active="{{ 'on' if target.is_active else 'off' }}"
                                data-img-url="{{ url_for('serve_screenshot', filename=target.screenshot_filename) if target.last_checked else '' }}">
                            ç¼–è¾‘
                        </button>
                        <form action="{{ url_for('execute_manual_check', target_id=target.id) }}" method="post" style="display:inline;">
                           <button type="submit" class="btn btn-sm btn-outline-success">æ‰§è¡Œ</button>
                        </form>
                        <form action="{{ url_for('delete_target', target_id=target.id) }}" method="post" style="display:inline;" onsubmit="return confirm('æ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ä¸ªç›‘æ§ç›®æ ‡å—ï¼Ÿ');">
                           <button type="submit" class="btn btn-sm btn-outline-danger">åˆ é™¤</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center py-5">
                <h4>è¿˜æ²¡æœ‰ç›‘æ§ç›®æ ‡</h4>
                <p class="text-muted">è¯·ç‚¹å‡»å³ä¸Šè§’çš„ "æ·»åŠ æ–°ç›®æ ‡" æ¥å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡ç›‘æ§ã€‚</p>
            </td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- æ·»åŠ /ç¼–è¾‘ç›®æ ‡çš„æ¨¡æ€æ¡† -->
<div class="modal fade" id="targetModal" tabindex="-1" aria-labelledby="targetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="targetForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="targetModalLabel">æ·»åŠ æ–°ç›®æ ‡</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="target_id" name="target_id">
            <div class="mb-3"><label for="name" class="form-label">ç›‘æ§åç§° (å¯é€‰)</label><input type="text" class="form-control" id="name" name="name" placeholder="ä¾‹å¦‚ï¼šè‹¹æœå®˜ç½‘é¦–é¡µ"></div>
            <div class="mb-3"><label for="url" class="form-label">ç›‘æ§ç½‘å€ (URL)</label><input type="url" class="form-control" id="url" name="url" placeholder="https://www.example.com" required></div>
            <div class="mb-3"><label for="cron_schedule" class="form-label">Cron è°ƒåº¦è®¡åˆ’</label><input type="text" class="form-control" id="cron_schedule" name="cron_schedule" value="*/5 * * * *" required><div class="form-text">é»˜è®¤ä¸ºæ¯5åˆ†é’Ÿã€‚æ ¼å¼: åˆ† æ—¶ æ—¥ æœˆ å‘¨ã€‚ <a href="https://crontab.guru/" target="_blank">Cron è¡¨è¾¾å¼åŠ©æ‰‹</a></div></div>
            <hr>
            <div class="row">
                <div class="col-md-4 mb-3"><label for="screenshot_width" class="form-label">æˆªå›¾å®½åº¦ (px)</label><input type="number" class="form-control" id="screenshot_width" name="screenshot_width" value="1920"></div>
                <div class="col-md-4 mb-3"><label for="screenshot_max_height" class="form-label">æœ€å¤§é«˜åº¦ (px)</label><input type="number" class="form-control" id="screenshot_max_height" name="screenshot_max_height" value="15000"></div>
                <div class="col-md-4 mb-3"><label for="threshold" class="form-label">å·®å¼‚é˜ˆå€¼</label><input type="number" class="form-control" id="threshold" name="threshold" value="500"></div>
            </div>
            <div class="mb-3">
                <label for="crop_area" class="form-label">æŒ‡å®šåŒºåŸŸ (JSON)</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="crop_area" name="crop_area" placeholder="[å·¦, ä¸Š, å³, ä¸‹] æˆ–ç‚¹å‡»å³ä¾§æŒ‰é’®é€‰å–">
                    <button class="btn btn-outline-secondary" type="button" id="select-area-btn" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-crop" viewBox="0 0 16 16"><path d="M3.5.5A.5.5 0 0 1 4 1v13h13a.5.5 0 0 1 0 1h-14a.5.5 0 0 1-.5-.5v-14a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1H4v1H1v13a.5.5 0 0 1-1 0v-13a.5.5 0 0 1 .5-.5z"/></svg>
                        é€‰å–åŒºåŸŸ
                    </button>
                </div>
                <div class="form-text">ç•™ç©ºè¡¨ç¤ºç›‘æ§æ•´ä¸ªé¡µé¢ã€‚ç¼–è¾‘æ—¶ï¼Œéœ€æœ‰å¿«ç…§æ‰èƒ½é€‰å–åŒºåŸŸã€‚</div>
            </div>
            <hr>
            <h6 class="mb-3">ç™»å½•è®¾ç½®</h6>
            <div class="mb-3"><label for="login_method" class="form-label">ç™»å½•æ–¹å¼</label><select class="form-select" id="login_method" name="login_method"><option value="none" selected>æ—  (ç”¨äºå…¬å¼€é¡µé¢)</option><option value="cookie">ä½¿ç”¨ Cookie</option><option value="credentials">ä½¿ç”¨è´¦å·å¯†ç </option></select></div>
            <div id="cookie-fields" class="mb-3 d-none"><label for="cookies" class="form-label">ç™»å½• Cookies (JSON æ ¼å¼)</label><textarea class="form-control" id="cookies" name="cookies" rows="4"></textarea><div class="form-text">è¯·å‚è€ƒæ–‡æ¡£ä¸­å…³äºå¦‚ä½•è·å– Cookies çš„è¯´æ˜ã€‚</div></div>
            <div id="credentials-fields" class="d-none">
                 <div class="alert alert-warning small"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" viewBox="0 0 16 16" role="img" aria-label="Warning:"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg><b>å®‰å…¨è­¦å‘Š</b>: å¯†ç å°†ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨ï¼Œè¯·ä»…ç”¨äºä¸æ•æ„Ÿçš„è´¦æˆ·ã€‚</div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label for="login_username" class="form-label">ç™»å½•è´¦å·</label><input type="text" class="form-control" id="login_username" name="login_username"></div>
                    <div class="col-md-6 mb-3"><label for="login_password" class="form-label">ç™»å½•å¯†ç </label><input type="password" class="form-control" id="login_password" name="login_password"></div>
                </div>
                <div class="mb-3"><label for="username_selector" class="form-label">è´¦å·è¾“å…¥æ¡†çš„ CSS é€‰æ‹©å™¨</label><input type="text" class="form-control" id="username_selector" name="username_selector" placeholder="#username æˆ– .user-input"></div>
                <div class="mb-3"><label for="password_selector" class="form-label">å¯†ç è¾“å…¥æ¡†çš„ CSS é€‰æ‹©å™¨</label><input type="text" class="form-control" id="password_selector" name="password_selector" placeholder="#password æˆ– [name='password']"></div>
                <div class="mb-3"><label for="submit_button_selector" class="form-label">ç™»å½•æŒ‰é’®çš„ CSS é€‰æ‹©å™¨</label><input type="text" class="form-control" id="submit_button_selector" name="submit_button_selector" placeholder="button[type='submit'] æˆ– .login-button"></div>
                <div class="form-text">è¯·å‚è€ƒæ–‡æ¡£ä¸­å…³äºå¦‚ä½•è·å– CSS é€‰æ‹©å™¨çš„è¯´æ˜ã€‚</div>
            </div>
            <hr>
            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="is_active" name="is_active" checked><label class="form-check-label" for="is_active">å¯ç”¨æ­¤ç›‘æ§ä»»åŠ¡</label></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- é€šçŸ¥è®¾ç½®çš„æ¨¡æ€æ¡† -->
<div class="modal fade" id="notificationSettingsModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('save_notifications') }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationModalLabel">å…¨å±€é€šçŸ¥è®¾ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="notificationAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTelegram">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTelegram" aria-expanded="true" aria-controls="collapseTelegram"><strong>âœˆï¸ Telegram é€šçŸ¥</strong></button>
                            </h2>
                            <div id="collapseTelegram" class="accordion-collapse collapse show" aria-labelledby="headingTelegram" data-bs-parent="#notificationAccordion">
                                <div class="accordion-body">
                                    <div class="mb-3"><label for="telegram_bot_token" class="form-label">Bot Token</label><input type="text" class="form-control" id="telegram_bot_token" name="telegram_bot_token" value="{{ notifications.telegram_bot_token if notifications }}"></div>
                                    <div class="mb-3"><label for="telegram_chat_id" class="form-label">Chat ID</label><input type="text" class="form-control" id="telegram_chat_id" name="telegram_chat_id" value="{{ notifications.telegram_chat_id if notifications }}"></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSmtp">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSmtp" aria-expanded="false" aria-controls="collapseSmtp"><strong>ğŸ“§ é‚®ä»¶é€šçŸ¥ (SMTP)</strong></button>
                            </h2>
                            <div id="collapseSmtp" class="accordion-collapse collapse" aria-labelledby="headingSmtp" data-bs-parent="#notificationAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-8 mb-3"><label for="smtp_host" class="form-label">SMTP ä¸»æœº</label><input type="text" class="form-control" id="smtp_host" name="smtp_host" value="{{ notifications.smtp_host if notifications }}"></div>
                                        <div class="col-md-4 mb-3"><label for="smtp_port" class="form-label">ç«¯å£</label><input type="number" class="form-control" id="smtp_port" name="smtp_port" value="{{ notifications.smtp_port if notifications }}"></div>
                                    </div>
                                    <div class="mb-3"><label for="smtp_user" class="form-label">ç”¨æˆ·å</label><input type="text" class="form-control" id="smtp_user" name="smtp_user" value="{{ notifications.smtp_user if notifications }}"></div>
                                    <div class="mb-3"><label for="smtp_password" class="form-label">å¯†ç æˆ–æˆæƒç </label><input type="password" class="form-control" id="smtp_password" name="smtp_password" value=""><div class="form-text">ä¸ºå®‰å…¨èµ·è§ï¼Œæ­¤å¤„ä¸æ˜¾ç¤ºå·²ä¿å­˜çš„å¯†ç ã€‚å¦‚éœ€ä¿®æ”¹ï¼Œè¯·ç›´æ¥è¾“å…¥æ–°å¯†ç ã€‚</div></div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3"><label for="smtp_from" class="form-label">å‘ä»¶äººåœ°å€</label><input type="email" class="form-control" id="smtp_from" name="smtp_from" value="{{ notifications.smtp_from if notifications }}"><div class="form-text">å¯ç•™ç©ºï¼Œé»˜è®¤ä¸ºç”¨æˆ·åã€‚</div></div>
                                        <div class="col-md-6 mb-3"><label for="to_email" class="form-label">æ”¶ä»¶äººåœ°å€</label><input type="email" class="form-control" id="to_email" name="to_email" value="{{ notifications.to_email if notifications }}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜é€šçŸ¥è®¾ç½®</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imagePreviewModalLabel">å¿«ç…§é¢„è§ˆ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img src="" id="modalImagePreview" class="img-fluid" alt="å®Œæ•´å¿«ç…§">
      </div>
    </div>
  </div>
</div>

<!-- äº¤äº’å¼è£å‰ªåŒºåŸŸé€‰æ‹©æ¨¡æ€æ¡† -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cropModalLabel">é€‰å–ç›‘æ§åŒºåŸŸ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
          <p id="crop-instructions" class="position-absolute top-50 start-50 translate-middle bg-dark text-white p-3 rounded" style="z-index: 3;">è¯·åœ¨å›¾ç‰‡ä¸ŠæŒ‰ä½é¼ æ ‡å·¦é”®å¹¶æ‹–åŠ¨ä»¥é€‰æ‹©åŒºåŸŸ</p>
          <img src="" id="crop-image" class="img-fluid" alt="å®Œæ•´å¿«ç…§">
          <canvas id="crop-canvas"></canvas>
      </div>
      <div class="modal-footer">
        <span id="coords-display" class="me-auto text-muted"></span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" id="confirm-crop-btn">ç¡®è®¤é€‰æ‹©</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var imagePreviewModal = document.getElementById('imagePreviewModal');
    if(imagePreviewModal) {
        imagePreviewModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var imageUrl = button.getAttribute('data-img-url');
            var imageName = button.getAttribute('data-img-name');
            var modalTitle = imagePreviewModal.querySelector('.modal-title');
            var modalImage = imagePreviewModal.querySelector('#modalImagePreview');
            modalTitle.textContent = 'å¿«ç…§é¢„è§ˆ: ' + imageName;
            modalImage.src = imageUrl + '?t=' + new Date().getTime();
        });
    }

    var targetModal = document.getElementById('targetModal');
    let currentImgUrlForCropper = '';

    if(targetModal) {
        targetModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var action = button.getAttribute('data-action');
            var form = document.getElementById('targetForm');
            var modalTitle = targetModal.querySelector('.modal-title');
            var selectAreaBtn = document.getElementById('select-area-btn');
            
            form.reset();
            document.getElementById('login_method').dispatchEvent(new Event('change'));
            
            if (action === 'add') {
                modalTitle.textContent = 'æ·»åŠ æ–°ç›®æ ‡';
                form.action = "{{ url_for('add_target') }}";
                document.getElementById('is_active').checked = true;
                document.getElementById('cron_schedule').value = '*/5 * * * *';
                document.getElementById('screenshot_width').value = 1920;
                document.getElementById('screenshot_max_height').value = 15000;
                document.getElementById('threshold').value = 500;
                selectAreaBtn.disabled = true;
                currentImgUrlForCropper = '';
            } else if (action === 'edit') {
                modalTitle.textContent = 'ç¼–è¾‘ç›‘æ§ç›®æ ‡';
                form.action = "{{ url_for('edit_target') }}";
                document.getElementById('target_id').value = button.getAttribute('data-id');
                document.getElementById('name').value = button.getAttribute('data-name');
                document.getElementById('url').value = button.getAttribute('data-url');
                document.getElementById('cron_schedule').value = button.getAttribute('data-cron');
                document.getElementById('screenshot_width').value = button.getAttribute('data-width');
                document.getElementById('screenshot_max_height').value = button.getAttribute('data-height');
                document.getElementById('threshold').value = button.getAttribute('data-threshold');
                document.getElementById('crop_area').value = button.getAttribute('data-crop');
                document.getElementById('cookies').value = button.getAttribute('data-cookies');
                document.getElementById('login_method').value = button.getAttribute('data-login-method') || 'none';
                document.getElementById('login_username').value = button.getAttribute('data-login-username');
                document.getElementById('login_password').value = button.getAttribute('data-login-password');
                document.getElementById('username_selector').value = button.getAttribute('data-username-selector');
                document.getElementById('password_selector').value = button.getAttribute('data-password-selector');
                document.getElementById('submit_button_selector').value = button.getAttribute('data-submit-button-selector');
                document.getElementById('is_active').checked = (button.getAttribute('data-active') === 'on');
                document.getElementById('login_method').dispatchEvent(new Event('change'));
                
                currentImgUrlForCropper = button.getAttribute('data-img-url');
                if (currentImgUrlForCropper) {
                    selectAreaBtn.disabled = false;
                } else {
                    selectAreaBtn.disabled = true;
                }
            }
        });
    }
    
    var loginMethodSelect = document.getElementById('login_method');
    if(loginMethodSelect){
        loginMethodSelect.addEventListener('change', function() {
            var cookieFields = document.getElementById('cookie-fields');
            var credentialsFields = document.getElementById('credentials-fields');
            if (this.value === 'cookie') {
                cookieFields.classList.remove('d-none');
                credentialsFields.classList.add('d-none');
            } else if (this.value === 'credentials') {
                cookieFields.classList.add('d-none');
                credentialsFields.classList.remove('d-none');
            } else {
                cookieFields.classList.add('d-none');
                credentialsFields.classList.add('d-none');
            }
        });
    }

    const cropModalEl = document.getElementById('cropModal')
    const cropModal = new bootstrap.Modal(cropModalEl);
    const cropImage = document.getElementById('crop-image');
    const cropCanvas = document.getElementById('crop-canvas');
    const ctx = cropCanvas.getContext('2d');
    const coordsDisplay = document.getElementById('coords-display');
    let isDrawing = false;
    let startX, startY, endX, endY;
    // --- â†“â†“â†“ [FIX] å£°æ˜ç”¨äºå­˜å‚¨ç¼©æ”¾æ¯”ä¾‹çš„å˜é‡ â†“â†“â†“ ---
    let scaleX = 1;
    let scaleY = 1;
    // --- â†‘â†‘â†‘ [FIX] ---

    document.getElementById('select-area-btn').addEventListener('click', function() {
        if (currentImgUrlForCropper) {
            cropImage.src = currentImgUrlForCropper + '?t=' + new Date().getTime();
            cropModal.show();
        } else {
            alert('æ²¡æœ‰å¯ç”¨çš„å¿«ç…§ç”¨äºé€‰æ‹©åŒºåŸŸã€‚è¯·å…ˆè‡³å°‘æˆåŠŸæ‰§è¡Œä¸€æ¬¡ç›‘æ§ã€‚');
        }
    });

    cropImage.onload = () => {
        cropCanvas.width = cropImage.clientWidth;
        cropCanvas.height = cropImage.clientHeight;
        
        // --- â†“â†“â†“ [FIX] è®¡ç®—å¹¶å­˜å‚¨çœŸå®çš„ç¼©æ”¾æ¯”ä¾‹ â†“â†“â†“ ---
        // naturalWidth/Height æ˜¯å›¾ç‰‡æ–‡ä»¶çš„åŸå§‹å°ºå¯¸
        // clientWidth/Height æ˜¯å›¾ç‰‡åœ¨æµè§ˆå™¨ä¸­æ˜¾ç¤ºçš„å°ºå¯¸
        scaleX = cropImage.naturalWidth / cropImage.clientWidth;
        scaleY = cropImage.naturalHeight / cropImage.clientHeight;
        // --- â†‘â†‘â†‘ [FIX] ---
        
        document.getElementById('crop-instructions').style.display = 'block';
        coordsDisplay.textContent = '';
        startX = startY = endX = endY = 0;
    };

    const getMousePos = (canvas, evt) => {
        const rect = canvas.getBoundingClientRect();
        return {
            x: evt.clientX - rect.left,
            y: evt.clientY - rect.top
        };
    }

    cropCanvas.addEventListener('mousedown', (e) => {
        e.preventDefault();
        const pos = getMousePos(cropCanvas, e);
        isDrawing = true;
        startX = pos.x;
        startY = pos.y;
        document.getElementById('crop-instructions').style.display = 'none';
    });

    cropCanvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        e.preventDefault();
        const pos = getMousePos(cropCanvas, e);
        endX = pos.x;
        endY = pos.y;
        
        ctx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
        ctx.fillStyle = 'rgba(0, 123, 255, 0.3)';
        ctx.strokeStyle = 'rgba(0, 123, 255, 0.8)';
        ctx.lineWidth = 1;

        ctx.fillRect(startX, startY, endX - startX, endY - startY);
        ctx.strokeRect(startX, startY, endX - startX, endY - startY);
        
        // --- â†“â†“â†“ [FIX] æ˜¾ç¤ºç»™ç”¨æˆ·çš„åæ ‡ä¹Ÿåº”è¯¥æ˜¯æœ€ç»ˆæ¢ç®—åçš„å¤§å›¾åæ ‡ â†“â†“â†“ ---
        const currentCoords = [
            Math.round(Math.min(startX, endX) * scaleX), 
            Math.round(Math.min(startY, endY) * scaleY), 
            Math.round(Math.max(startX, endX) * scaleX), 
            Math.round(Math.max(startY, endY) * scaleY)
        ];
        coordsDisplay.textContent = `[${currentCoords.join(', ')}]`;
        // --- â†‘â†‘â†‘ [FIX] ---
    });

    const stopDrawing = (e) => {
        if (!isDrawing) return;
        e.preventDefault();
        isDrawing = false;
        const pos = getMousePos(cropCanvas, e);
        endX = pos.x;
        endY = pos.y;
    }

    cropCanvas.addEventListener('mouseup', stopDrawing);
    cropCanvas.addEventListener('mouseleave', stopDrawing);

    document.getElementById('confirm-crop-btn').addEventListener('click', function() {
        // --- â†“â†“â†“ [FIX] åœ¨ä¿å­˜æ—¶ï¼Œå°†æ˜¾ç¤ºåæ ‡ä¹˜ä»¥ç¼©æ”¾æ¯”ä¾‹ï¼Œå¾—åˆ°çœŸå®åæ ‡ â†“â†“â†“ ---
        const left = Math.round(Math.min(startX, endX) * scaleX);
        const top = Math.round(Math.min(startY, endY) * scaleY);
        const right = Math.round(Math.max(startX, endX) * scaleX);
        const bottom = Math.round(Math.max(startY, endY) * scaleY);
        // --- â†‘â†‘â†‘ [FIX] ---

        if (right - left > 5 && bottom - top > 5) { // é¿å…è¿‡å°çš„è¯¯æ“ä½œ
            const cropAreaValue = `[${left}, ${top}, ${right}, ${bottom}]`;
            document.getElementById('crop_area').value = cropAreaValue;
        } else {
            document.getElementById('crop_area').value = ""; // å¦‚æœé€‰åŒºå¤ªå°ï¼Œåˆ™æ¸…ç©º
        }
        
        ctx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
        cropModal.hide();
    });
    
    cropModalEl.addEventListener('hidden.bs.modal', function () {
        ctx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
    });
});

function toggleTarget(element) {
    var targetId = element.dataset.id;
    fetch('/target/toggle/' + targetId, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status !== 'success') {
            alert('çŠ¶æ€æ›´æ–°å¤±è´¥: ' + data.message);
            element.checked = !element.checked;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼ŒçŠ¶æ€æ›´æ–°å¤±è´¥ã€‚');
        element.checked = !element.checked;
    });
}
</script>
{% endblock %}
