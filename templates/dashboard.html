{% extends "base.html" %}

{% block title %}仪表盘 - 网页变化监控系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">监控仪表盘</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#notificationSettingsModal">
            通知设置
        </button>
        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#targetModal" data-action="add">
            添加新目标
        </button>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category or 'success' }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th scope="col">状态</th>
                <th scope="col">监控目标</th>
                <th scope="col">调度计划 (Cron)</th>
                <th scope="col" class="text-center">最新快照</th>
                <th scope="col">上次检查</th>
                <th scope="col">上次变化</th>
                <th scope="col" style="min-width: 220px;">操作</th>
            </tr>
        </thead>
        <tbody>
            {% for target in targets %}
            <tr>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="toggle-{{ target.id }}" 
                               data-id="{{ target.id }}" onchange="toggleTarget(this)" {% if target.is_active %}checked{% endif %}>
                    </div>
                </td>
                <td>
                    <strong>{{ target.name or '未命名目标' }}</strong><br>
                    <small><a href="{{ target.url }}" target="_blank" title="{{ target.url }}">{{ target.url[:50] }}{% if target.url|length > 50 %}...{% endif %}</a></small>
                </td>
                <td><code>{{ target.cron_schedule }}</code></td>
                <td class="text-center">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#imagePreviewModal" 
                       data-img-url="{{ url_for('serve_screenshot', filename=target.screenshot_filename) }}"
                       data-img-name="{{ target.name or target.url }}">
                        <img src="{{ url_for('serve_screenshot', filename=target.screenshot_filename) }}?t={{ now().timestamp()|int }}" 
                             alt="快照预览" class="img-thumbnail" style="max-width: 150px; max-height: 80px; display: none;"
                             onload="this.style.display='inline-block'"
                             onerror="this.parentElement.innerHTML = '<span class=&quot;text-muted&quot;>暂无快照</span>'">
                    </a>
                </td>
                <td>{{ target.last_checked.strftime('%y-%m-%d %H:%M:%S') if target.last_checked else '从未' }}</td>
                <td>{{ target.last_changed.strftime('%y-%m-%d %H:%M:%S') if target.last_changed else '无变化' }}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#targetModal"
                                data-action="edit"
                                data-id="{{ target.id }}"
                                data-name="{{ target.name }}"
                                data-url="{{ target.url }}"
                                data-cron="{{ target.cron_schedule }}"
                                data-width="{{ target.screenshot_width }}"
                                data-height="{{ target.screenshot_max_height }}"
                                data-threshold="{{ target.threshold }}"
                                data-crop="{{ target.crop_area }}"
                                data-cookies="{{ target.cookies }}"
                                data-login-method="{{ target.login_method }}"
                                data-login-username="{{ target.login_username }}"
                                data-login-password="{{ target.login_password }}"
                                data-username-selector="{{ target.username_selector }}"
                                data-password-selector="{{ target.password_selector }}"
                                data-submit-button-selector="{{ target.submit_button_selector }}"
                                data-active="{{ 'on' if target.is_active else 'off' }}"
                                data-img-url="{{ url_for('serve_screenshot', filename=target.screenshot_filename) if target.last_checked else '' }}">
                            编辑
                        </button>
                        <form action="{{ url_for('execute_manual_check', target_id=target.id) }}" method="post" style="display:inline;">
                           <button type="submit" class="btn btn-sm btn-outline-success">执行</button>
                        </form>
                        <form action="{{ url_for('delete_target', target_id=target.id) }}" method="post" style="display:inline;" onsubmit="return confirm('您确定要永久删除这个监控目标吗？');">
                           <button type="submit" class="btn btn-sm btn-outline-danger">删除</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center py-5">
                <h4>还没有监控目标</h4>
                <p class="text-muted">请点击右上角的 "添加新目标" 来开始您的第一次监控。</p>
            </td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 添加/编辑目标的模态框 -->
<div class="modal fade" id="targetModal" tabindex="-1" aria-labelledby="targetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="targetForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="targetModalLabel">添加新目标</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="target_id" name="target_id">
            <!-- ... 其他表单字段保持不变 ... -->
            <div class="mb-3"><label for="name" class="form-label">监控名称 (可选)</label><input type="text" class="form-control" id="name" name="name" placeholder="例如：苹果官网首页"></div>
            <div class="mb-3"><label for="url" class="form-label">监控网址 (URL)</label><input type="url" class="form-control" id="url" name="url" placeholder="https://www.example.com" required></div>
            <div class="mb-3"><label for="cron_schedule" class="form-label">Cron 调度计划</label><input type="text" class="form-control" id="cron_schedule" name="cron_schedule" value="*/5 * * * *" required><div class="form-text">默认为每5分钟。格式: 分 时 日 月 周。 <a href="https://crontab.guru/" target="_blank">Cron 表达式助手</a></div></div>
            <hr>
            <div class="row">
                <div class="col-md-4 mb-3"><label for="screenshot_width" class="form-label">截图宽度 (px)</label><input type="number" class="form-control" id="screenshot_width" name="screenshot_width" value="1920"></div>
                <div class="col-md-4 mb-3"><label for="screenshot_max_height" class="form-label">最大高度 (px)</label><input type="number" class="form-control" id="screenshot_max_height" name="screenshot_max_height" value="15000"></div>
                <div class="col-md-4 mb-3"><label for="threshold" class="form-label">差异阈值</label><input type="number" class="form-control" id="threshold" name="threshold" value="500"></div>
            </div>
            <!-- --- ↓↓↓ [MODIFICATION] ↓↓↓ --- -->
            <div class="mb-3">
                <label for="crop_area" class="form-label">指定区域 (JSON)</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="crop_area" name="crop_area" placeholder="[左, 上, 右, 下] 或点击右侧按钮选取">
                    <button class="btn btn-outline-secondary" type="button" id="select-area-btn" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-crop" viewBox="0 0 16 16"><path d="M3.5.5A.5.5 0 0 1 4 1v13h13a.5.5 0 0 1 0 1h-14a.5.5 0 0 1-.5-.5v-14a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1H4v1H1v13a.5.5 0 0 1-1 0v-13a.5.5 0 0 1 .5-.5z"/></svg>
                        选取区域
                    </button>
                </div>
                <div class="form-text">留空表示监控整个页面。编辑时，需有快照才能选取区域。</div>
            </div>
            <!-- --- ↑↑↑ [MODIFICATION] ↑↑↑ --- -->
            <hr>
            <h6 class="mb-3">登录设置</h6>
            <!-- ... 其他表单字段保持不变 ... -->
            <div class="mb-3"><label for="login_method" class="form-label">登录方式</label><select class="form-select" id="login_method" name="login_method"><option value="none" selected>无 (用于公开页面)</option><option value="cookie">使用 Cookie</option><option value="credentials">使用账号密码</option></select></div>
            <div id="cookie-fields" class="mb-3 d-none"><label for="cookies" class="form-label">登录 Cookies (JSON 格式)</label><textarea class="form-control" id="cookies" name="cookies" rows="4"></textarea><div class="form-text">请参考文档中关于如何获取 Cookies 的说明。</div></div>
            <div id="credentials-fields" class="d-none">
                 <div class="alert alert-warning small"><b>安全警告</b>: 密码将以明文形式存储，请仅用于不敏感的账户。</div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label for="login_username" class="form-label">登录账号</label><input type="text" class="form-control" id="login_username" name="login_username"></div>
                    <div class="col-md-6 mb-3"><label for="login_password" class="form-label">登录密码</label><input type="password" class="form-control" id="login_password" name="login_password"></div>
                </div>
                <div class="mb-3"><label for="username_selector" class="form-label">账号输入框的 CSS 选择器</label><input type="text" class="form-control" id="username_selector" name="username_selector" placeholder="#username 或 .user-input"></div>
                <div class="mb-3"><label for="password_selector" class="form-label">密码输入框的 CSS 选择器</label><input type="text" class="form-control" id="password_selector" name="password_selector" placeholder="#password 或 [name='password']"></div>
                <div class="mb-3"><label for="submit_button_selector" class="form-label">登录按钮的 CSS 选择器</label><input type="text" class="form-control" id="submit_button_selector" name="submit_button_selector" placeholder="button[type='submit'] 或 .login-button"></div>
                <div class="form-text">请参考文档中关于如何获取 CSS 选择器的说明。</div>
            </div>
            <hr>
            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="is_active" name="is_active" checked><label class="form-check-label" for="is_active">启用此监控任务</label></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 通知设置的模态框 (无变化) -->
<div class="modal fade" id="notificationSettingsModal" tabindex="-1" ...>
    <!-- ... 内容保持不变 ... -->
</div>

<!-- 图片预览模态框 (无变化) -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" ...>
    <!-- ... 内容保持不变 ... -->
</div>

<!-- --- ↓↓↓ [NEW FEATURE] 交互式裁剪区域选择模态框 ↓↓↓ --- -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cropModalLabel">选取监控区域</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center p-0 position-relative">
          <p id="crop-instructions" class="position-absolute top-50 start-50 translate-middle bg-dark text-white p-3 rounded">请在图片上按住鼠标左键并拖动以选择区域</p>
          <img src="" id="crop-image" class="img-fluid" alt="完整快照" style="cursor: crosshair;">
          <canvas id="crop-canvas" class="position-absolute top-0 left-0"></canvas>
      </div>
      <div class="modal-footer">
        <span id="coords-display" class="me-auto text-muted"></span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="confirm-crop-btn">确认选择</button>
      </div>
    </div>
  </div>
</div>
<!-- --- ↑↑↑ [NEW FEATURE] 交互式裁剪区域选择模态框 ↑↑↑ --- -->

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // 旧的JS代码保持不变...
    var imagePreviewModal = document.getElementById('imagePreviewModal');
    // ...

    var targetModal = document.getElementById('targetModal');
    let currentImgUrlForCropper = '';

    if(targetModal) {
        targetModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var action = button.getAttribute('data-action');
            var form = document.getElementById('targetForm');
            var modalTitle = targetModal.querySelector('.modal-title');
            var selectAreaBtn = document.getElementById('select-area-btn');
            
            if (action === 'add') {
                modalTitle.textContent = '添加新目标';
                form.action = "{{ url_for('add_target') }}";
                form.reset();
                // 新增时没有图片，禁用选取按钮
                selectAreaBtn.disabled = true;
                currentImgUrlForCropper = '';
            } else if (action === 'edit') {
                modalTitle.textContent = '编辑监控目标';
                form.action = "{{ url_for('edit_target') }}";
                // ... (填充表单的逻辑不变)
                document.getElementById('target_id').value = button.getAttribute('data-id');
                document.getElementById('name').value = button.getAttribute('data-name');
                document.getElementById('url').value = button.getAttribute('data-url');
                document.getElementById('cron_schedule').value = button.getAttribute('data-cron');
                document.getElementById('screenshot_width').value = button.getAttribute('data-width');
                document.getElementById('screenshot_max_height').value = button.getAttribute('data-height');
                document.getElementById('threshold').value = button.getAttribute('data-threshold');
                document.getElementById('crop_area').value = button.getAttribute('data-crop');
                // ... (其他字段)
                
                // 检查是否有图片URL，有则启用按钮
                currentImgUrlForCropper = button.getAttribute('data-img-url');
                if (currentImgUrlForCropper) {
                    selectAreaBtn.disabled = false;
                } else {
                    selectAreaBtn.disabled = true;
                }
            }
            document.getElementById('login_method').dispatchEvent(new Event('change'));
        });
    }
    
    // --- ↓↓↓ [NEW FEATURE SCRIPT] 裁剪区域选择的JS逻辑 ↓↓↓ ---
    const cropModal = new bootstrap.Modal(document.getElementById('cropModal'));
    const cropImage = document.getElementById('crop-image');
    const cropCanvas = document.getElementById('crop-canvas');
    const ctx = cropCanvas.getContext('2d');
    const coordsDisplay = document.getElementById('coords-display');
    let isDrawing = false;
    let startX, startY, endX, endY;

    document.getElementById('select-area-btn').addEventListener('click', function() {
        if (currentImgUrlForCropper) {
            cropImage.src = currentImgUrlForCropper + '?t=' + new Date().getTime(); // 加时间戳防止缓存
            cropModal.show();
        } else {
            alert('没有可用的快照用于选择区域。请先至少成功执行一次监控。');
        }
    });

    cropImage.onload = () => {
        // 使canvas和图片尺寸匹配
        cropCanvas.width = cropImage.clientWidth;
        cropCanvas.height = cropImage.clientHeight;
        document.getElementById('crop-instructions').style.display = 'block';
    };

    cropCanvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        startX = e.offsetX;
        startY = e.offsetY;
        document.getElementById('crop-instructions').style.display = 'none';
    });

    cropCanvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        endX = e.offsetX;
        endY = e.offsetY;
        
        // 清除上一帧的矩形并重绘
        ctx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
        ctx.fillStyle = 'rgba(0, 123, 255, 0.3)'; // 半透明蓝色
        ctx.strokeStyle = 'rgba(0, 123, 255, 0.8)'; // 深蓝色边框
        ctx.lineWidth = 1;

        ctx.fillRect(startX, startY, endX - startX, endY - startY);
        ctx.strokeRect(startX, startY, endX - startX, endY - startY);
        
        coordsDisplay.textContent = `[${Math.min(startX, endX)}, ${Math.min(startY, endY)}, ${Math.max(startX, endX)}, ${Math.max(startY, endY)}]`;
    });

    cropCanvas.addEventListener('mouseup', (e) => {
        isDrawing = false;
        endX = e.offsetX;
        endY = e.offsetY;
    });
    
    cropCanvas.addEventListener('mouseleave', () => {
        if(isDrawing) { // 如果拖动到画布外松开，也视为结束
             isDrawing = false;
        }
    });

    document.getElementById('confirm-crop-btn').addEventListener('click', function() {
        const left = Math.round(Math.min(startX, endX));
        const top = Math.round(Math.min(startY, endY));
        const right = Math.round(Math.max(startX, endX));
        const bottom = Math.round(Math.max(startY, endY));

        if (right - left > 0 && bottom - top > 0) {
            const cropAreaValue = `[${left}, ${top}, ${right}, ${bottom}]`;
            document.getElementById('crop_area').value = cropAreaValue;
        }
        
        ctx.clearRect(0, 0, cropCanvas.width, cropCanvas.height); // 清理画布
        cropModal.hide();
    });
    // --- ↑↑↑ [NEW FEATURE SCRIPT] 裁剪区域选择的JS逻辑 ↑↑↑ ---
});

function toggleTarget(element) {
    // ... (此函数保持不变)
}
</script>
{% endblock %}
